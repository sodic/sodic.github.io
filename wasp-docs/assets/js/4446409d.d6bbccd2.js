"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[3686],{3905:(e,t,a)=>{a.d(t,{Zo:()=>h,kt:()=>c});var n=a(67294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function r(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var l=n.createContext({}),p=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},h=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,h=r(e,["components","mdxType","originalType","parentName"]),u=p(a),m=o,c=u["".concat(l,".").concat(m)]||u[m]||d[m]||i;return a?n.createElement(c,s(s({ref:t},h),{},{components:a})):n.createElement(c,s({ref:t},h))}));function c(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=a.length,s=new Array(i);s[0]=m;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r[u]="string"==typeof e?e:o,s[1]=r;for(var p=2;p<i;p++)s[p]=a[p];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},38610:(e,t,a)=>{a.d(t,{Z:()=>i});var n=a(67294),o=a(44996);const i=e=>n.createElement("div",null,n.createElement("p",{align:"center"},n.createElement("figure",null,n.createElement("img",{style:{width:e.width},alt:e.alt,src:(0,o.Z)(e.source)}),n.createElement("figcaption",{class:"image-caption",style:{fontStyle:"italic",opacity:.6,fontSize:"0.9rem"}},e.caption))))},52482:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>r,default:()=>m,frontMatter:()=>s,metadata:()=>l,toc:()=>h});var n=a(87462),o=(a(67294),a(3905)),i=(a(39960),a(44996),a(38610));const s={title:"How we built a GPT code agent that generates full-stack web apps in React & Node.js, explained simply",authors:["martinsos"],image:"/img/how-we-built-gpt-wasp/generator-logs.png",tags:["mage","wasp-ai","GPT"]},r=void 0,l={permalink:"/blog/2023/07/17/how-we-built-gpt-web-app-generator",editUrl:"https://github.com/wasp-lang/wasp/edit/release/web/blog/2023-07-17-how-we-built-gpt-web-app-generator.md",source:"@site/blog/2023-07-17-how-we-built-gpt-web-app-generator.md",title:"How we built a GPT code agent that generates full-stack web apps in React & Node.js, explained simply",description:"<ImgWithCaption",date:"2023-07-17T00:00:00.000Z",formattedDate:"July 17, 2023",tags:[{label:"mage",permalink:"/blog/tags/mage"},{label:"wasp-ai",permalink:"/blog/tags/wasp-ai"},{label:"GPT",permalink:"/blog/tags/gpt"}],readingTime:22.68,hasTruncateMarker:!1,authors:[{name:"Martin Sosic",title:"Co-founder & CTO @ Wasp",url:"https://github.com/martinsos",email:"martin@wasp-lang.dev",imageURL:"https://github.com/martinsos.png",key:"martinsos"}],frontMatter:{title:"How we built a GPT code agent that generates full-stack web apps in React & Node.js, explained simply",authors:["martinsos"],image:"/img/how-we-built-gpt-wasp/generator-logs.png",tags:["mage","wasp-ai","GPT"]},prevItem:{title:"Smol AI \ud83d\udc23 vs. Wasp AI \ud83d\udc1d - Which is the Better AI Junior Developer?",permalink:"/blog/2023/08/01/smol-ai-vs-wasp-ai"},nextItem:{title:"GPT Web App Generator - Let AI create a full-stack React & Node.js codebase based on your description \ud83e\udd16\ud83e\udd2f",permalink:"/blog/2023/07/10/gpt-web-app-generator"}},p={authorsImageUrls:[void 0]},h=[{value:"How well does it work \ud83e\udd14?",id:"how-well-does-it-work-",level:2},{value:"How does it work \u2699\ufe0f?",id:"how-does-it-work-\ufe0f",level:2},{value:"\ud83c\udfb6 Intermezzo: short explanation of OpenAI Chat Completions API",id:"-intermezzo-short-explanation-of-openai-chat-completions-api",level:3},{value:"Step #1: Planning \ud83d\udcdd",id:"step-1-planning-",level:3},{value:"\ud83c\udfb6 Intermezzo: Common prompt design",id:"-intermezzo-common-prompt-design",level:3},{value:"Step #2: Generating \ud83c\udfed",id:"step-2-generating-",level:3},{value:"Step #3: Fixing \ud83d\udd27",id:"step-3-fixing-",level:3},{value:"Things we tried/learned",id:"things-we-triedlearned",level:2},{value:"Explanations \ud83d\udcac",id:"explanations-",level:3},{value:"Testing \ud83e\uddea",id:"testing-",level:3},{value:"Context vs smarts \ud83e\udde0",id:"context-vs-smarts-",level:3},{value:"Handling JSON as a response \ud83d\udccb",id:"handling-json-as-a-response-",level:3},{value:"Handling interruptions in the service \ud83d\udea7",id:"handling-interruptions-in-the-service-",level:3},{value:"Temperature \ud83c\udf21\ufe0f",id:"temperature-\ufe0f",level:3},{value:"Future \ud83d\udd2e",id:"future-",level:2},{value:"Support us! \u2b50\ufe0f",id:"support-us-\ufe0f",level:2}],u={toc:h},d="wrapper";function m(e){let{components:t,...a}=e;return(0,o.kt)(d,(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)(i.Z,{source:"img/how-we-built-gpt-wasp/generator-logs-yellow.png",mdxType:"ImgWithCaption"}),(0,o.kt)("p",null,"We created ",(0,o.kt)("a",{parentName:"p",href:"https://magic-app-generator.wasp-lang.dev/"},"GPT Web App Generator"),", which lets you shortly describe the web app you would like to create, and in a matter of minutes, a full-stack codebase, written in React, Node.js, Prisma, and Wasp, will be generated right in front of you, and available to download and run locally!"),(0,o.kt)("p",null,"We started this as an experiment, to see how well we could use GPT to generate full-stack web apps in ",(0,o.kt)("a",{parentName:"p",href:"https://wasp-lang.dev/"},"Wasp"),", the open-source JS web app framework that we are developing. Since we launched, we had more than 3000 apps generated in just a couple of days!"),(0,o.kt)(i.Z,{source:"img/gpt-wasp/how-it-works.gif",caption:"1. Describe your app 2. Pick the color 3. Generate your app \ud83d\ude80",mdxType:"ImgWithCaption"}),(0,o.kt)("p",null,"Check out ",(0,o.kt)("a",{parentName:"p",href:"https://wasp-lang.dev/blog/2023/07/10/gpt-web-app-generator"},"this blog post")," to see GPT Web App Generator in action, including a one-minute demo video, few example apps, and learn a bit more about our plans for the future. Or, try it out yourself at ",(0,o.kt)("a",{parentName:"p",href:"https://magic-app-generator.wasp-lang.dev/"},"https://magic-app-generator.wasp-lang.dev/")," !"),(0,o.kt)("p",null,"In this blog post, ",(0,o.kt)("strong",{parentName:"p"},"we are going to explore the technical side of creating the GPT Web App Generator"),": techniques we used, how we engineered our prompts, challenges we encountered, and choices we made! (Note from here on we will just refer to it as the \u201cGenerator\u201d, or \u201ccode agent\u201d when talking about the backend)"),(0,o.kt)("p",null,"Also, all the code behind the Generator is open source: ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/wasp/blob/737ab428edf38f245cd9f8db60b637b723352e55/wasp-ai"},"web app"),", ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/wasp/blob/737ab428edf38f245cd9f8db60b637b723352e55/waspc/src/Wasp/AI"},"GPT code agent"),"."),(0,o.kt)("h2",{id:"how-well-does-it-work-"},"How well does it work \ud83e\udd14?"),(0,o.kt)("p",null,"First, let\u2019s quickly explain what we ended up with and how it performs."),(0,o.kt)("p",null,"Input into our Generator is the app name, app description (free form text), and a couple of simple options such as primary app color, temperature, auth method, and GPT model to use."),(0,o.kt)(i.Z,{source:"img/how-we-built-gpt-wasp/todo-input.png",caption:"Input for generating a Todo app",mdxType:"ImgWithCaption"}),(0,o.kt)("p",null,"As an output, Generator spits out the whole JS codebase of a working full-stack web app: frontend, backend, and database. Frontend is React + Tailwind, the backend is NodeJS with Express, and for working with the database we used Prisma. This is all connected together with the Wasp framework."),(0,o.kt)("p",null,"You can see an example of generated codebase here: ",(0,o.kt)("a",{parentName:"p",href:"https://magic-app-generator.wasp-lang.dev/result/07ed440a-3155-4969-b3f5-2031fb1f622f"},"https://magic-app-generator.wasp-lang.dev/result/07ed440a-3155-4969-b3f5-2031fb1f622f")," ."),(0,o.kt)(i.Z,{source:"img/how-we-built-gpt-wasp/todo-results.png",caption:"Result of generating a Todo app",mdxType:"ImgWithCaption"}),(0,o.kt)("p",null,"Generator does its best to produce code that works out of the box \u2192 you can download it to your machine and run it. For simpler apps, such as ",(0,o.kt)("a",{parentName:"p",href:"https://magic-app-generator.wasp-lang.dev/result/07ed440a-3155-4969-b3f5-2031fb1f622f"},"TodoApp")," or ",(0,o.kt)("a",{parentName:"p",href:"https://magic-app-generator.wasp-lang.dev/result/3bb5dca2-f134-4f96-89d6-0812deab6e0c"},"MyPlants"),", it often generates code with no mistakes, and you can run them out of the box."),(0,o.kt)(i.Z,{source:"img/gpt-wasp/todo-app.png",caption:"What generated TodoApp looks like",mdxType:"ImgWithCaption"}),(0,o.kt)("p",null,"For a bit more complex apps, like a blog with posts and comments, it still generates a reasonable codebase but there are some mistakes to be expected here and there. For even more complex apps, it usually doesn\u2019t follow up completely, but stops at some level of complexity and fills in the rest with TODOs or omits functionality, so it is kind of like a simplified model of what was asked for. Overall, it is optimized for producing CRUD business web apps."),(0,o.kt)("p",null,"This makes it a great tool for kick-starting your next web app project with a solid prototype, or to even generate working, simple apps on the fly!"),(0,o.kt)("h2",{id:"how-does-it-work-\ufe0f"},"How does it work \u2699\ufe0f?"),(0,o.kt)("p",null,"When we set out to build the Generator, we gave ourselves the following goals:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"we must be able to build it in a couple of weeks"),(0,o.kt)("li",{parentName:"ul"},"it has to be relatively easy to maintain in the future"),(0,o.kt)("li",{parentName:"ul"},"it needs to generate the app quickly and cheaply (a couple of minutes, < $1)"),(0,o.kt)("li",{parentName:"ul"},"generated apps should have as few mistakes as possible")),(0,o.kt)("p",null,"Therefore, to keep it simple, we don\u2019t do any LLM-level engineering or fine-tuning, instead, ",(0,o.kt)("strong",{parentName:"p"},"we just use OpenAI API (specifically GPT3.5 and GPT4) to generate different parts of the app while giving it the right context at every moment (pieces of docs, examples, guidelines, \u2026)"),". To ensure the coherence and quality of the generated app, we don\u2019t give our code agent too much freedom but instead heavily guide it, step by step, through generating the app."),(0,o.kt)("p",null,"As ",(0,o.kt)("strong",{parentName:"p"},"step zero"),", we generate some code files deterministically, without GPT, just based on the options that the user chose (primary color, auth method): those include some config files for the project, some basic global CSS, and some auth logic. You can see this logic here (we call those \u201cskeleton\u201d files): ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/wasp/blob/737ab428edf38f245cd9f8db60b637b723352e55/waspc/src/Wasp/AI/GenerateNewProject/Skeleton.hs"},"code on Github")," ."),(0,o.kt)("p",null,"Then, the code agent takes over!"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"The code agent does its work in 3 main phases"),":"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Planning \ud83d\udcdd")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Generating \ud83c\udfed")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Fixing \ud83d\udd27"))),(0,o.kt)("p",null,"Since GPT4 is quite slower and significantly more expensive than GPT3.5 (also has a lower rate limit regarding the number of tokens per minute, and also the number of requests per minute), we use GPT4 only for the planning, since that is the crucial step, and then after that, we use GPT3.5 for the rest."),(0,o.kt)("p",null,"As for ",(0,o.kt)("strong",{parentName:"p"},"cost per app")," \ud83d\udcb8: one app typically consumes from 25k to 60k tokens, which comes to about ",(0,o.kt)("strong",{parentName:"p"},"$0.1 to $0.2")," per app, when we use a mix of GPT4 and GPT3.5. If we run it just with GPT4, then the cost is 10x, which is from ",(0,o.kt)("strong",{parentName:"p"},"$1 to $2"),"."),(0,o.kt)("h3",{id:"-intermezzo-short-explanation-of-openai-chat-completions-api"},"\ud83c\udfb6 Intermezzo: short explanation of OpenAI Chat Completions API"),(0,o.kt)("p",null,"OpenAI API offers different services, but we used only one of them: \u201cchat completions\u201d."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"API itself is actually very simple: you send over a conversation, and you get a response from the GPT.")),(0,o.kt)("p",null,"The conversation is just a list of messages, where each message has content and a role, where the role specifies who \u201csaid\u201d that content \u2192 was it \u201cuser\u201d (you), or \u201cassistant\u201d (GPT)."),(0,o.kt)("p",null,"The important thing to note is that ",(0,o.kt)("strong",{parentName:"p"},"there is no concept of state/memory: every API call is completely standalone"),", and the only thing that GPT knows about is the conversation you provide it with at that moment!"),(0,o.kt)("p",null,"If you are wondering how ChatGPT (the web app that uses GPT in the background) works with no memory \u2192 well, each time you write a message, the whole conversation so far is resent again! There are some additional smart mechanisms in play here, but that is really it at its core."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://platform.openai.com/docs/guides/gpt/chat-completions-api"},"Official guide"),", ",(0,o.kt)("a",{parentName:"p",href:"https://platform.openai.com/docs/api-reference/chat/create"},"official API reference"),"."),(0,o.kt)("h3",{id:"step-1-planning-"},"Step #1: Planning \ud83d\udcdd"),(0,o.kt)("p",null,"A Wasp app consists of Entities (Prisma data models), Operations (NodeJS Queries and Actions), and Pages (React)."),(0,o.kt)("p",null,"Once given an app description and title, ",(0,o.kt)("strong",{parentName:"p"},"the code agent first generates a Plan"),": it is a list of Entities, Operations (Queries and Actions), and Pages that comprise the app. So kind of like an initial draft of the app. It doesn\u2019t generate the code yet \u2192 instead, it comes up with their names and some other details, including a short description of what they should behave like."),(0,o.kt)(i.Z,{source:"img/how-we-built-gpt-wasp/gen-logs-planning.png",mdxType:"ImgWithCaption"}),(0,o.kt)("p",null,"This is done via a single API request toward GPT, where the prompt consists of the following:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Short ",(0,o.kt)("strong",{parentName:"li"},"info about the Wasp")," framework + an example of some Wasp code."),(0,o.kt)("li",{parentName:"ul"},"We ",(0,o.kt)("strong",{parentName:"li"},"explain that we want to generate the Plan"),", explain what it is, and how it is represented as ",(0,o.kt)("strong",{parentName:"li"},"JSON"),", by describing its schema."),(0,o.kt)("li",{parentName:"ul"},"We provide some ",(0,o.kt)("strong",{parentName:"li"},"examples of the Plan"),", represented as JSON."),(0,o.kt)("li",{parentName:"ul"},"Some ",(0,o.kt)("strong",{parentName:"li"},"rules and guidelines")," we want it to follow (e.g. \u201cplan should have at least 1 page\u201d, \u201cmake sure to generate a User entity\u201d)."),(0,o.kt)("li",{parentName:"ul"},"Instructions to return the Plan only as a ",(0,o.kt)("strong",{parentName:"li"},"valid JSON response"),", and no other text."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"App name and description")," (as provided by the user).")),(0,o.kt)("p",null,"You can see how we generate such a prompt in the code ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/wasp/blob/737ab428edf38f245cd9f8db60b637b723352e55/waspc/src/Wasp/AI/GenerateNewProject/Plan.hs#L61"},"here"),"."),(0,o.kt)("details",null,(0,o.kt)("summary",null," Also, here is an actual instance of this prompt for a TodoApp. "),(0,o.kt)("div",null,(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'Wasp is a full-stack web app framework that uses React (for client), NodeJS and Prisma (for server).\nHigh-level of the app is described in main.wasp file (which is written in special Wasp DSL), details in JS/JSX files.\nWasp DSL (used in main.wasp) reminds a bit of JSON, and doesn\'t use single quotes for strings, only double quotes. Examples will follow.\n\nImportant Wasp features:\n  - Routes and Pages: client side, Pages are written in React.\n  - Queries and Actions: RPC, called from client, execute on server (nodejs).\n    Queries are for fetching and should not do any mutations, Actions are for mutations.\n  - Entities: central data models, defined via PSL (Prisma schema language), manipulated via Prisma.\nTypical flow: Routes point to Pages, Pages call Queries and Actions, Queries and Actions work with Entities.\n\nExample main.wasp (comments are explanation for you):\n\n```wasp\napp todoApp {\n  wasp: { version: "^0.11.1" },\n  title: "ToDo App",\n  auth: {\n    userEntity: User,\n    methods: { usernameAndPassword: {} },\n    onAuthFailedRedirectTo: "/login"\n  },\n  client: {\n    rootComponent: import { Layout } from "@client/Layout.jsx",\n  },\n  db: {\n    prisma: {\n      clientPreviewFeatures: ["extendedWhereUnique"]\n    }\n  },\n}\n\nroute SignupRoute { path: "/signup", to: SignupPage }\npage SignupPage {\n  component: import Signup from "@client/pages/auth/Signup.jsx"\n}\n\nroute LoginRoute { path: "/login", to: LoginPage }\npage LoginPage {\n  component: import Login from "@client/pages/auth/Login.jsx"\n}\n\nroute DashboardRoute { path: "/", to: Dashboard }\npage DashboardPage {\n  authRequired: true,\n  component: import Dashboard from "@client/pages/Dashboard.jsx"\n}\n\nentity User {=psl\n    id          Int       @id @default(autoincrement())\n    username    String    @unique\n    password    String\n    tasks       Task[]\npsl=}\n\nentity Task {=psl\n    id          Int       @id @default(autoincrement())\n    description String\n    isDone      Boolean   @default(false)\n    user        User      @relation(fields: [userId], references: [id])\n    userId      Int\npsl=}\n\nquery getUser {\n  fn: import { getUser } from "@server/queries.js",\n  entities: [User] // Entities that this query operates on.\n}\n\nquery getTasks {\n  fn: import { getTasks } from "@server/queries.js",\n  entities: [Task]\n}\n\naction createTask {\n  fn: import { createTask } from "@server/actions.js",\n  entities: [Task]\n}\n\naction updateTask {\n  fn: import { updateTask } from "@server/actions.js",\n  entities: [Task]\n}\n```\n\nWe are looking for a plan to build a new Wasp app (description at the end of prompt).\n\nInstructions you must follow while generating plan:\n  - App uses username and password authentication.\n  - App MUST have a \'User\' entity, with following fields required:\n  - `id Int @id @default(autoincrement())`\n  - `username String @unique`\n  - `password String`\nIt is also likely to have a field that refers to some other entity that user owns, e.g. `tasks Task[]`.\n  - One of the pages in the app must have a route path "/".\n  - Don\'t generate the Login or Signup pages and routes under any circumstances. They are already generated.\n\nPlan is represented as JSON with the following schema:\n\n{\n  "entities": [{ "entityName": string, "entityBodyPsl": string }],\n  "actions": [{ "opName": string, "opFnPath": string, "opDesc": string }],\n  "queries": [{ "opName": string, "opFnPath": string, "opDesc": string }],\n  "pages": [{ "pageName": string, "componentPath": string, "routeName": string, "routePath": string, "pageDesc": string }]\n}\n\nHere is an example of a plan (a bit simplified, as we didn\'t list all of the entities/actions/queries/pages):\n\n{\n  "entities": [{\n    "entityName": "User",\n    "entityBodyPsl": "  id Int @id @default(autoincrement())\\n  username String @unique\\n  password String\\n  tasks Task[]"\n  }],\n  "actions": [{\n    "opName": "createTask",\n    "opFnPath": "@server/actions.js",\n    "opDesc": "Checks that user is authenticated and if so, creates new Task belonging to them. Takes description as an argument and by default sets isDone to false. Returns created Task."\n  }],\n  "queries": [{\n    "opName": "getTask",\n    "opFnPath": "@server/queries.js",\n    "opDesc": "Takes task id as an argument. Checks that user is authenticated, and if so, fetches and returns their task that has specified task id. Throws HttpError(400) if tasks exists but does not belong to them."\n  }],\n  "pages": [{\n    "pageName": "TaskPage",\n    "componentPath": "@client/pages/Task.jsx",\n    "routeName: "TaskRoute",\n    "routePath": "/task/:taskId",\n    "pageDesc": "Diplays a Task with the specified taskId. Allows editing of the Task. Uses getTask query and createTask action.",\n  }]\n}\n\nWe will later use this plan to write main.wasp file and all the other parts of Wasp app,\nso make sure descriptions are detailed enough to guide implementing them.\nAlso, mention in the descriptions of actions/queries which entities they work with,\nand in descriptions of pages mention which actions/queries they use.\n\nTypically, plan will have AT LEAST one query, at least one action, at least one page, and at\nleast two entities. It will very likely have more than one of each, though.\n\nDO NOT create actions for login and logout under any circumstances. They are already included in Wasp.\n\nNote that we are using SQLite as a database for Prisma, so don\'t use scalar arrays in PSL, like `String[]`,\nas those are not supported in SQLite. You can of course normally use arrays of other models, like `Task[]`.\n\nPlease, respond ONLY with a valid JSON that is a plan.\nThere should be no other text in the response.\n\n==== APP DESCRIPTION: ====\n\nApp name: TodoApp\nA simple todo app with one main page that lists all the tasks. User can create new tasks by providing their description, toggle existing ones, or edit their description. User owns tasks. User can only see and edit their own tasks. Tasks are saved in the database.\n')))),(0,o.kt)("p",null,"GPT then responds with a JSON (hopefully), that we parse, and we have ourselves a Plan! We will use this Plan in the following steps, to drive our generation of other parts of the app. Note that GPT sometimes adds text to the JSON response or returns invalid JSON, so we built in some simple approaches to overcome these issues, which we explain in detail later."),(0,o.kt)("h3",{id:"-intermezzo-common-prompt-design"},"\ud83c\udfb6 Intermezzo: Common prompt design"),(0,o.kt)("p",null,"The prompt design we just described above for generating a Plan is actually very similar for other steps (e.g. the Generation and Fixing steps along with their respective sub-steps), so let\u2019s cover those commonalities."),(0,o.kt)("p",null,"All of the prompts we use more or less adhere to the same basic structure:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"General context"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Short info about what Wasp framework is."),(0,o.kt)("li",{parentName:"ul"},"Doc snippets (with code examples if needed) about whatever we are generating right now (e.g. examples of NodeJS code, or examples of React code)."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Project context"),": stuff we generated in the previous steps that is relevant to the current step."),(0,o.kt)("li",{parentName:"ul"},"Instructions on ",(0,o.kt)("strong",{parentName:"li"},"what we want to generate right now")," + JSON schema for it + example of such JSON response."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Rules and guidelines"),": this is a good place to warn it about common mistakes it makes, or give it some additional advice, and emphasize what needs to happen and what must not happen."),(0,o.kt)("li",{parentName:"ul"},"Instructions to ",(0,o.kt)("strong",{parentName:"li"},"respond only with a valid JSON"),", and no other text."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Original user prompt"),": app name and description (as provided by the user).")),(0,o.kt)("p",null,"We put the original user prompt at the end because then we can tell GPT in the system message after it sees the start of the original user prompt (we have a special header for it), that it needs to treat everything after it as an app description and not as instructions on what to do \u2192 this way we attempt to ",(0,o.kt)("strong",{parentName:"p"},"defend from the potential prompt injection"),"."),(0,o.kt)("h3",{id:"step-2-generating-"},"Step #2: Generating \ud83c\udfed"),(0,o.kt)("p",null,"After producing the Plan, Generator goes step by step through the Plan and asks GPT to generate each web app piece, while providing it with docs, examples, and guidelines. Each time a web app piece is generated, Generator fits it into the whole app. This is where most of our work comes in: ",(0,o.kt)("strong",{parentName:"p"},"equipping GPT with the right information at the right moment"),"."),(0,o.kt)(i.Z,{source:"img/how-we-built-gpt-wasp/gen-logs-generating.png",mdxType:"ImgWithCaption"}),(0,o.kt)("p",null,"In our case, we do it for all the Operations in the Plan (Actions and Queries: NodeJs code), and also for all the Pages in the Plan (React code), with one prompt for each. So if we have 2 queries, 3 actions, and 2 pages, that will be 2+3+2 = 7 GPT prompts/requests. Prompts are designed as explained previously."),(0,o.kt)("p",null,"Code on Github: ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/wasp/blob/737ab428edf38f245cd9f8db60b637b723352e55/waspc/src/Wasp/AI/GenerateNewProject/Operation.hs"},"generating an Operation"),", ",(0,o.kt)("a",{parentName:"p",href:"https://www.notion.so/Postavi-da-mijenjamo-verziju-cabala-stalno-https-github-com-wasp-lang-wasp-issues-892-fb4f0edb0a024951ad236f82030008a5?pvs=21"},"generating a Page"),"."),(0,o.kt)("p",null,"When generating Operations, we provide GPT with the info about the previously generated Entities, while when generating Pages, we provide GPT with the info about previously generated Entities and Operations."),(0,o.kt)("h3",{id:"step-3-fixing-"},"Step #3: Fixing \ud83d\udd27"),(0,o.kt)("p",null,"Finally, the Generator tries its best to fix any mistakes that GPT might have introduced previously. ",(0,o.kt)("strong",{parentName:"p"},"GPT loves fixing stuff it previously generated")," \u2192 if you first ask it to generate some code, and then just tell it to fix it, it will often improve it!"),(0,o.kt)("p",null,"To enhance this process further, we don\u2019t just ask it to fix previous code, but also provide it with instructions on what to keep an eye out for, like common types of mistakes that we noticed it often does, and also point it to any specific mistakes we were able to detect on our own."),(0,o.kt)("p",null,"Regarding detecting mistakes to report to GPT, ",(0,o.kt)("strong",{parentName:"p"},"ideally, you would have a full REPL going on")," \u2192 that means running the generated code through an interpreter/compiler, then sending it for repairs, and so on until all is fixed."),(0,o.kt)("p",null,"In our case, running the whole project through the TypeScript compiler was not feasible for us with the time limits we put on ourselves, but ",(0,o.kt)("strong",{parentName:"p"},"we used some simpler static analysis tools")," like Wasp\u2019s compiler (for the .wasp file) and ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma format")," for Prisma model schemas, and sent those to GPT to fix them. We also wrote some ",(0,o.kt)("strong",{parentName:"p"},"simple heuristics of our own that are able to detect some of the common mistakes"),"."),(0,o.kt)(i.Z,{source:"img/how-we-built-gpt-wasp/gen-logs-fixing.png",mdxType:"ImgWithCaption"}),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/wasp/blob/737ab428edf38f245cd9f8db60b637b723352e55/waspc/src/Wasp/AI/GenerateNewProject/PageComponentFile.hs#L122"},"Our code (& prompt) for fixing a Page"),"."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/wasp/blob/737ab428edf38f245cd9f8db60b637b723352e55/waspc/src/Wasp/AI/GenerateNewProject/OperationsJsFile.hs#L26"},"Our code (& prompt) for fixing Operations"),"."),(0,o.kt)("p",null,"In the prompt, we would usually repeat the same guidelines we provided previously in the Generation step, while also adding a couple of additional pointers to common mistakes, and that usually helps, it fixes stuff it missed before. But, often not everything, instead something will still get through. ",(0,o.kt)("strong",{parentName:"p"},"Some things we just couldn\u2019t get it to fix consistently"),", for example, Wasp-specific JS imports, no matter how much we emphasized what it needed to do with them, it would just keep messing them up. Even GPT4 wasn\u2019t perfect in this situation. For such situations, when possible, we ended up writing ",(0,o.kt)("strong",{parentName:"p"},"our own heuristics that would fix those mistakes")," (",(0,o.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/wasp/blob/737ab428edf38f245cd9f8db60b637b723352e55/waspc/src/Wasp/AI/GenerateNewProject/PageComponentFile.hs#L49"},"fixing JS imports"),")."),(0,o.kt)("h2",{id:"things-we-triedlearned"},"Things we tried/learned"),(0,o.kt)("h3",{id:"explanations-"},"Explanations \ud83d\udcac"),(0,o.kt)("p",null,"We tried telling GPT to explain what it did while fixing mistakes: which mistakes it will fix, and which mistakes it fixed, since we read that that can help, but ",(0,o.kt)("strong",{parentName:"p"},"we didn\u2019t see visible improvement in its performance"),"."),(0,o.kt)("h3",{id:"testing-"},"Testing \ud83e\uddea"),(0,o.kt)("p",null,"Testing the performance of your code agent is hard."),(0,o.kt)("p",null,"In our case, it takes a couple of minutes for our code agent to generate a new app, and you need to run tests directly with the OpenAI API. Also, ",(0,o.kt)("strong",{parentName:"p"},"since results are non-deterministic, it can be pretty hard to say if output was affected by the changes")," you did or not."),(0,o.kt)("p",null,"Finally, evaluating the output itself can be hard (especially in our case when it is a whole full-stack web app)."),(0,o.kt)("p",null,"Ideally, we would have set up a system where we can run only parts of the whole generation process, and we could automatically run a specific part a number of times for each of different sets of parameters (which would include different prompts, but also parameters like type of model (gpt4 vs gpt3.5), temperature and similar), in order to compare performance for each of those parameter sets."),(0,o.kt)("p",null,"Evaluation performance would also ideally be automated, e.g. we would count the mistakes during compilation and/or evaluate the quality of app design \u2192 but this is also quite hard."),(0,o.kt)("p",null,"We, unfortunately, didn\u2019t have time to set up such a system, so ",(0,o.kt)("strong",{parentName:"p"},"we were mostly doing testing manually, which is quite subjective and vulnerable to randomness"),", and is effective only for changes that have quite a big impact, while you can\u2019t really detect those that are minor optimizations."),(0,o.kt)("h3",{id:"context-vs-smarts-"},"Context vs smarts \ud83e\udde0"),(0,o.kt)("p",null,"When we started working on the Generator, we thought the size of GPT\u2019s context would be the main issue. However, we didn\u2019t have any issues with context at the end \u2192 most of what we wanted to specify would fit into 2k to max 4k tokens, while GPT3.5 has context up to 16k!"),(0,o.kt)("p",null,"Instead, ",(0,o.kt)("strong",{parentName:"p"},"we had bigger problems with its \u201csmarts\u201d")," \u2192 meaning that GPT would not follow the rules we very explicitly told it to follow, or would do things we explicitly forbid it from doing. GPT4 proved to be better at following rules than GPT3.5, but even GPT4 would keep doing some mistakes over and over and forgetting about specific rules (even though there was more than enough context). The \u201cfixing\u201d step did help with this: we would repeat the rules there and GPT would pick up more of them, but often still not all of them."),(0,o.kt)("h3",{id:"handling-json-as-a-response-"},"Handling JSON as a response \ud83d\udccb"),(0,o.kt)("p",null,"As mentioned earlier in this article, in all our interactions with GPT, we always ask it to return the response as JSON, for which we specify the schema and give some examples."),(0,o.kt)("p",null,"However, GPT still doesn\u2019t always follow that rule, and will sometimes add some text around the JSON, or will make a mistake in formatting JSON."),(0,o.kt)("p",null,"The way we handled this is with two simple fixes:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Upon receiving JSON, we would remove all the characters from the start until we hit ",(0,o.kt)("inlineCode",{parentName:"li"},"{"),", and also all chars from the end until we hit ",(0,o.kt)("inlineCode",{parentName:"li"},"}"),". Simple heuristic, but it works very well for removing redundant text around the JSON in practice since GPT will normally not have any ",(0,o.kt)("inlineCode",{parentName:"li"},"{")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"}")," in that text."),(0,o.kt)("li",{parentName:"ol"},"If we fail to parse JSON, we send it again for repairs, to GPT. We include the previous prompt and its last answer (that contains invalid JSON) and add instructions to fix it + JSON parse errors we got. We repeat this a couple of times until it gets it right (or until we give up).")),(0,o.kt)("p",null,"In practice, ",(0,o.kt)("strong",{parentName:"p"},"these two methods took care of invalid JSON in 99% of the cases for us"),"."),(0,o.kt)("p",null,"NOTE: While we were implementing our code agent, OpenAI released new functionality for GPT, \u201cfunctions\u201d, which is basically a mechanism to have GPT respond with a structured JSON, following the schema of your description. So it would likely make more sense to do this with \u201cfunctions\u201d, but we already had this working well so we just stuck with it.  "),(0,o.kt)("h3",{id:"handling-interruptions-in-the-service-"},"Handling interruptions in the service \ud83d\udea7"),(0,o.kt)("p",null,"We were calling OpenAI API directly, so we noticed quickly that often it would return 503 - service unavailable - especially during peak hours (e.g. 3 pm CET)."),(0,o.kt)("p",null,"Therefore, it is recommended to have some kind of retry mechanism, ideally with exponential backoff, that makes your code agent redundant to such random interruptions in the service, and also to potential rate limiting. ",(0,o.kt)("strong",{parentName:"p"},"We went with the retry mechanism with exponential backoff and it worked great"),"."),(0,o.kt)("h3",{id:"temperature-\ufe0f"},"Temperature \ud83c\udf21\ufe0f"),(0,o.kt)("p",null,"Temperature determines how creative GPT is, but the more creative it gets, the less \u201cstable\u201d it is. It hallucinates more and also has a harder time following rules.\nA temperature is a number from 0 to 2, with a default value of 1."),(0,o.kt)("p",null,"We experimented with different values and found the following:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"\u2265 1.5")," would every so and so start giving quite silly results with random strings in it."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"\u2265 1.0, < 1.5")," was okish but was introducing a bit too many mistakes."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"\u2265 0.7, < 1.0")," was optimal \u2192 creative enough, while still not having many mistakes."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"\u2264 0.7")," seemed to perform similarly to a bit higher values, but with a bit less creativity maybe.")),(0,o.kt)("p",null,"That said, I don\u2019t think we tested values below 0.7 enough, and that is something we could certainly work on more."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"We ended up using 0.7 as our default value, except for prompts that do fixing, for those we used a lower value of 0.5")," because it seemed like GPT was changing stuff too much while fixing at 0.7 (being too creative). Our logic was: let it be creative when writing the first version of the code, then have it be a bit more conventional while fixing it. Again, we haven\u2019t tested all this enough, so this is certainly something I would like us to explore more. "),(0,o.kt)("h2",{id:"future-"},"Future \ud83d\udd2e"),(0,o.kt)("p",null,"While we ended up being impressed with the performance of what we managed to build in such a short time, we were also left wanting to try so many different ideas on how to improve it further. There are many avenues left to be explored in this ecosystem that is developing so rapidly, that it is hard to reach the point where you feel like you explored all the options and found the optimal solution."),(0,o.kt)("p",null,"Some of the ideas that would be exciting to try in the future:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"We put quite a few limitations regarding the code that our code agent generates, to make sure it works well enough: we don\u2019t allow it to create helper files, to include npm dependencies, no TypeScript, no advanced Wasp features, \u2026 . ",(0,o.kt)("strong",{parentName:"p"},"We would love to lift the limitations"),", therefore allowing the creation of more complex and powerful apps.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Instead of our code agent doing everything in one shot, we could ",(0,o.kt)("strong",{parentName:"p"},"allow the user to interact with it")," after the first version of the app is generated: to provide additional prompts, for example, to fix something, to add some feature to the app, to do something differently, \u2026. The hardest thing here would be figuring out which context to provide to the GPT at which moment and designing the experience appropriately, but I am certain it is doable, and it would take the Generator to the next level of usability.\nAnother option is to allow intervention in between initial generation steps \u2192 for example, after the plan is generated, to allow the user to adjust it by providing additional instructions to the GPT.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Find an open-source ",(0,o.kt)("strong",{parentName:"p"},"LLM that fits the purpose and fine-tune / pre-train it for our purpose"),". If we could teach it more about Wasp and the technologies we use, so we don\u2019t have to include it in every prompt, we could save quite some context + have the LLM be more focused on the rules and guidelines we are specifying in the prompt. We could also host it ourselves and have more control over the costs and rate limits.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Take a ",(0,o.kt)("strong",{parentName:"p"},"different approach to the code agent: let it be more free"),". Instead of guiding it so carefully, we could teach it about all the different things it is allowed to ask for (ask for docs, ask for examples, ask to generate a certain piece of the app, ask to see a certain already generated piece of the app, \u2026) and would let it guide itself more freely. It could constantly generate a plan, execute it, update the plan, and so on until it reaches the state of equilibrium. This approach potentially promises more flexibility and would likely be able to generate apps of greater complexity, but it also requires quite more tokens and a powerful LLM to drive it \u2192 I believe this approach will become more feasible as LLMs become more capable."))),(0,o.kt)("h2",{id:"support-us-\ufe0f"},"Support us! \u2b50\ufe0f"),(0,o.kt)("p",null,"If you wish to express your support for what we are doing, consider giving us a ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/wasp"},"star on Github"),"! Everything we do at Wasp is open source, and your support motivates us and helps us to keep making web app development easier and with less boilerplate."),(0,o.kt)("p",null,"Also, if you have any ideas on how we could improve our code agent, or maybe we can help you somehow -> feel free to join our ",(0,o.kt)("a",{parentName:"p",href:"https://discord.gg/rzdnErX"},"Discord server")," and let's chat!"))}m.isMDXComponent=!0}}]);